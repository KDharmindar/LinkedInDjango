{% extends 'app/base.html' %}
{% load static %}


{%block pagecss%}
    <link href="{% static 'css/AdminLTE.css' %}" rel="stylesheet" type="text/css" id="maincss">
    <link href="{% static 'css/camp.css' %}" rel="stylesheet" type="text/css" id="maincss1">
    <link href="{% static 'css/account.css' %}" rel="stylesheet" type="text/css" id="maincss2">
{%endblock%}
    
{% block title %}Campaign Messenger{% endblock title %}

{%block header%}
   {% include 'app/includes/header.html' with account_menu=1 %}
{%endblock%}

{%block sidebar%}
   
{%endblock%}


{%block content%}

<section class="content">
   
   	<div class="nav-tabs-custom">
	<ul class="nav nav-tabs">
	  <li id="cname" class="pull-right col-md-3 col-sm-4 col-xs-5">		
		<label class="switch pull-right" style="margin-top:6px">
		  <input type="checkbox" checked="{%if object.active%} checked {%endif%}" class="switch_campaign" data-cid="{{object.id}}">
		  <div class="slider round"></div>
		</label>
		
		<h4>{{object.title}}</h4>
	  </li>
	  <li class="active"><a href="#tab_1" data-toggle="tab">People</a></li>
	  <li><a href="#tab_2" data-toggle="tab">Steps</a></li>
	  <li><a href="#tab_3" data-toggle="tab">Settings</a></li>
	  <li><a href="#tab_4" data-toggle="tab">Stats</a></li>

	  
	</ul>
	<div class="tab-content">
	  <div class="tab-pane active" id="tab_1">
					<div class="row">
	<div class="col-md-9" style="position:relative">
					</div>
	<div class="col-md-3" id="uinfo_box">
		
	</div>
</div>
		<h4>To get things going with this Messenger Campaign:</h4>
	<p>1. Go to <a href="{%url 'account-network' acc_pk=acc_pk %}">My Network</a>.</p>
	<p>2. Find people you would like to add to this Messenger Campaign.</p>
	<p>3. Select and add people you would like to contact by clicking "Add Selected People to Messenger Campaign" or "Add All New People to Messenger Campaign" button.</p>
				  </div>
	  <!-- /.tab-pane -->
	  <div class="tab-pane" id="tab_2" style="">
	  		<form name="campaign" method="POST" action="{% url 'messenger-campaign' acc_pk=acc_pk pk=object.pk %}">
	  		{% csrf_token %}
	  		
			<div class="row">
				<div class="col-md-9">
					<div class="box">
						<div class="box-body">
							<div class="form-group">
								<label>MESSAGE 1</label>
								{{form.welcome_message}}
							</div>
						</div>
					</div>
					
					{% include 'app/includes/campaigns/step_formset.html' with campaignsteps=campaignsteps %}
											
						
						
				</div>
				
				<div class="col-md-3">
					<input type="submit" class="btn btn-primary btn-block btn-save" name="save" value="SAVE">
					
					<div class="box msg_vars">
						<div class="box-body">
							<p class="title">You can use these tags in place of an individual's details to build a more personalized message.</p>
							
							<p>Name<span>{Name}<span></span></span></p>
							<p>First name<span>{FirstName}<span></span></span></p>
							<p>Company name<span>{Company}<span></span></span></p>
							<p>Title<span>{Title}<span></span></span></p>
						</div>
					</div>
				</div>
			</div>
			
			
			
			
			</form>

	  	  </div>
	  <!-- /.tab-pane -->
	  <div class="tab-pane" id="tab_3">
	  		<div class="row">
	<div class="col-md-6">
		<div class="box box-success">
			<div class="box-header">
			  <h3 class="box-title">Messenger Campaign Status</h3>
			</div>
		
			<div class="box-body">
				<p style="font-size:16px;min-height:123px;">
				You can turn this Messenger Campaign on and off. Turned on campaign will send out connection requests and messages according to your <a href="#tab_2" data-toggle="tab" onclick="$('.nav-tabs li').removeClass('active');$('.nav-tabs li:eq(1)').addClass('active');">messaging settings</a>. If you turn off the campaign, all campaign activity will be paused.</p>
				
				<label class="switch pull-left" style="margin-right:20px">
				  <input type="checkbox" checked="{%if object.active%} checked {%endif%}" class="switch_campaign" data-cid="{{object.id}}">
				  <div class="slider round"></div>
				</label>
				
				<h5 style="margin-top:16px;">Campaign is active</h5>
			</div>
		</div>
	</div>
	
	<div class="col-md-6">
		<div class="box box-danger">
			<div class="box-header">
			  <h3 class="box-title">Delete Messenger Campaign</h3>
			</div>
		
			<div class="box-body">
				<p style="font-size:16px;min-height:120px;">Deleting Messenger Campaign will stop all campaign activity. Contacts from the campaign will remain in 'My Network' and in your 'Inbox', however, and will no longer receive automated campaign messages. Contact(s) status will change to "Old Connect". You will be able to continue manual communication with these contacts.</p>
				
				<a href="#" class="btn btn-flat btn-danger" data-click="removeCampaign" data-cid="{{object.id}}">DELETE MESSENGER CAMPAIGN</a>
			</div>
		</div>
	</div>
</div>	  	  </div>
	  <!-- /.tab-pane -->
	  <div class="tab-pane" id="tab_4">
	  		<div class="row">
	<div class="col-sm-4 stats_block">
		<h1>0</h1>
		<p>Contacts</p>
	</div>
	
	<div class="col-sm-4 stats_block">
		<div style="display:inline;width:100px;height:100px;"><canvas width="100" height="100"></canvas><input type="text" class="knob" data-displayinput="false" data-readonly="true" value="" data-width="100" data-height="100" data-fgcolor="#00c1fe" readonly="readonly" style="display: none; width: 0px; visibility: hidden;"></div>
		<div class="nums">
			<h2>0%</h2>
			<h3>0</h3>
		</div>
		<p>Messages</p>
	</div>
	
	<div class="col-sm-4 stats_block">
		<div style="display:inline;width:100px;height:100px;"><canvas width="100" height="100"></canvas><input type="text" class="knob" data-displayinput="false" data-readonly="true" value="" data-width="100" data-height="100" data-fgcolor="#00b257" readonly="readonly" style="display: none; width: 0px; visibility: hidden;"></div>
		<div class="nums">
			<h2>0%</h2>
			<h3>0</h3>
		</div>
		<p>Replied</p>
	</div>
</div>	  	  </div>
	  <!-- /.tab-pane -->
	</div>
	<!-- /.tab-content -->
</div>	</section>

{%endblock%}

{%block pagefooter%}

<script src="{% static 'js/jquery.formset.js' %}?v=1"></script>
<script type="text/javascript">
    $(function() {
        
        $('.campaignsteps-row>div').formset({
            // For inline formsets, be sure to set the prefix, as the default prefix
            // ('form') isn't correct.
            // Django appears to generate the prefix from the lowercase plural
            // name of the related model, with camel-case converted to underscores.
            prefix: 'stepmessages',
            addText: 'Add another message',          // Text for the add link
            deleteText: 'Remove this message',            // Text for the delete link
            addCssClass: 'add-row btn btn-primary',          // CSS class applied to the add link
            deleteCssClass: 'delete-row btn btn-danger mb-xl',    // CSS class applied to the delete link
        });
        
        
        $('.slider').click(function(e){
        	
        	var that = $(e.target).prev();
        	that.click();
        	console.log('checked:', that.is(":checked"));
        	var url = window.location.href;
        	var data = "active=" + (that.is(":checked") ? 1 : 0);
        	
        	$.get(url+"/active?"+data).done(function(res){
        		$('body').find('.switch_campaign').each(function(ex){        		
            		if (this !== that){
            			$(this).trigger('click');
            		}
            	});
        	});
        	
        	
        	
        });
        
        $('.btn-save').click(function(e){
        	e.preventDefault();
        	var that = $(this);
        	var form = that.closest('form');
        	var data = form.serialize();
        	$.post(form.attr('action'), data).done(function(res){
        		res = $.parseJSON(res);
        		console.log('resutl:', res);
        		var alertbox = $('.alert-box');
        		if (res.ok) {
        			alertbox.html('Message has been saved successfully!');
        			alertbox.addClass('text-success').removeClass('text-danger');
        			return;
        		}
        		if ( res.error){
        			var html = "";
        			$.each( res.error, function( i, obj ) {
        				var key = Object.keys(obj);
        				html+=  key + ": " + obj[key] + "<br/>";
        			});
        			//console.log('html:', html);
        			alertbox.html( html );
        			alertbox.removeClass('text-success').addClass('text-danger')
        		}
        	});
        });
        
        $("a[data-click='removeCampaign']").click(function(e) {
    		e.preventDefault();
    		$('#confirm_dialog>div').modal('show');
    	});
        
        $('body').on('click', '#confirm_dialog >div #confirm_button', function(e){
        	
        	var url = window.location.href;
        	var data = $('body').find('form[name="campaign"]').serialize();        	
        	$.post(url+"/delete", data).done(function(res){
        		var to = url.lastIndexOf('/');
            	to = to == -1 ? url.length : to + 1;
            	var url2 = url.substring(0, to);
        		window.location = url2;
        	});
        	
        });
        
    });
    
</script>
<div id="confirm_dialog"><div class="modal fade" tabindex="-1" role="dialog" style="display: none;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">x</span></button>
        <h4 class="modal-title">Delete Connector Campaign</h4>
      </div>
      <div class="modal-body">
        <h5>Are you sure you want to delete this Connector Campaign ?</h5>
		<p class="text-red">This Connector Campaign will be deleted permanently. You will be able to manually communicate with your existing LinkedIn contacts from 'My Network' and from your 'Inbox' pages.</p>
      </div>
	  
	  <input type="hidden" name="cid" value="">
	  
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary add_button" id="confirm_button">Delete</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal --></div>
	

{%endblock%}